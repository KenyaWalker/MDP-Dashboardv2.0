<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - MDP Dashboard</title>
    <link rel="icon" type="image/png" href="SC_Logo_Symbol_RGB_WHT.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0062AD 0%, #11224B 100%);
            color: #333;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header img {
            height: 50px;
        }

        .header h1 {
            color: #0062AD;
            font-size: 2em;
            font-weight: 700;
        }

        .admin-badge {
            background: #FF9800;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .admin-card {
            background: rgba(255, 255, 255, 0.98);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .admin-card h3 {
            color: #0062AD;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .admin-btn {
            background: #0062AD;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: left;
        }

        .admin-btn:hover {
            background: #00358E;
            transform: translateY(-2px);
        }

        .admin-btn.danger {
            background: #f44336;
        }

        .admin-btn.danger:hover {
            background: #d32f2f;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-item h4 {
            color: #0062AD;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-item p {
            color: #666;
            font-weight: 600;
        }

        .data-management {
            background: rgba(255, 255, 255, 0.98);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .recent-activity {
            background: rgba(255, 255, 255, 0.98);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .activity-item {
            padding: 15px;
            border-bottom: 1px solid #E1E8ED;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-info {
            flex: 1;
        }

        .activity-info h5 {
            color: #11224B;
            margin-bottom: 5px;
        }

        .activity-info p {
            color: #666;
            font-size: 0.9em;
        }

        .activity-time {
            color: #888;
            font-size: 0.9em;
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #0062AD;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .links {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }

        .links a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 600;
            padding: 12px 25px;
            border: 2px solid white;
            border-radius: 25px;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .links a:hover {
            background: white;
            color: #0062AD;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .admin-grid {
                grid-template-columns: 1fr;
            }

            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <img src="SC_Logo_Symbol_RGB_WHT.png" alt="Sam's Club Logo">
                <h1>MDP Admin Panel</h1>
                <span class="admin-badge">ADMIN</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="stats-overview">
            <div class="stat-item">
                <h4 id="totalEvaluations">0</h4>
                <p>Total Evaluations</p>
            </div>
            <div class="stat-item">
                <h4 id="uniqueMDPs">0</h4>
                <p>Unique MDPs</p>
            </div>
            <div class="stat-item">
                <h4 id="uniqueManagers">0</h4>
                <p>Active Managers</p>
            </div>
            <div class="stat-item">
                <h4 id="averageScore">0.0</h4>
                <p>Average Score</p>
            </div>
        </div>

        <div class="admin-grid">
            <div class="admin-card">
                <h3>üìä Data Management</h3>
                <div class="admin-actions">
                    <button class="admin-btn" onclick="exportAllData()">Export All Data (CSV)</button>
                    <button class="admin-btn" onclick="exportFilteredData()">Export Filtered Data</button>
                    <button class="admin-btn" onclick="refreshStats()">Refresh Statistics</button>
                    <button class="admin-btn" onclick="downloadBackup()">Download Backup</button>
                </div>
            </div>

            <div class="admin-card">
                <h3>üîß System Tools</h3>
                <div class="admin-actions">
                    <button class="admin-btn" onclick="viewSystemHealth()">System Health Check</button>
                    <button class="admin-btn" onclick="clearCache()">Clear Application Cache</button>
                    <button class="admin-btn" onclick="generateReport()">Generate Performance Report</button>
                    <button class="admin-btn" onclick="viewLogs()">View System Logs</button>
                </div>
            </div>

            <div class="admin-card">
                <h3>‚ö†Ô∏è Data Cleanup</h3>
                <div class="admin-actions">
                    <button class="admin-btn" onclick="findDuplicates()">Find Duplicate Entries</button>
                    <button class="admin-btn" onclick="validateData()">Validate Data Integrity</button>
                    <button class="admin-btn danger" onclick="confirmBulkDelete()">Bulk Delete Old Data</button>
                    <button class="admin-btn danger" onclick="confirmResetSystem()">Reset All Data</button>
                </div>
            </div>

            <div class="admin-card">
                <h3>üìà Analytics</h3>
                <div class="admin-actions">
                    <button class="admin-btn" onclick="viewTrends()">Performance Trends</button>
                    <button class="admin-btn" onclick="managerAnalytics()">Manager Analytics</button>
                    <button class="admin-btn" onclick="functionAnalysis()">Function Analysis</button>
                    <button class="admin-btn" onclick="rotationProgress()">Rotation Progress</button>
                </div>
            </div>
        </div>

        <div class="recent-activity">
            <h3>Recent Activity</h3>
            <div id="recentActivity">
                <div class="activity-item">
                    <div class="activity-info">
                        <h5>Loading recent activity...</h5>
                        <p>Please wait while we fetch the latest data</p>
                    </div>
                    <div class="activity-time">Just now</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Action</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalMessage">Are you sure you want to proceed?</div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="admin-btn" onclick="closeModal()">Cancel</button>
                <button class="admin-btn danger" id="confirmBtn" onclick="executeAction()">Confirm</button>
            </div>
        </div>
    </div>

    <div class="links">
        <a href="/">Submit Survey</a>
        <a href="/dashboard.html">View Dashboard</a>
    </div>

    <script>
        let currentAction = null;
        let allData = [];

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            loadAdminData();
            loadRecentActivity();
        });

        // Load admin statistics
        async function loadAdminData() {
            try {
                const response = await fetch('/api/survey-responses');
                if (response.ok) {
                    allData = await response.json();
                    updateAdminStats();
                } else {
                    console.error('Failed to load admin data');
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        // Update admin statistics
        function updateAdminStats() {
            document.getElementById('totalEvaluations').textContent = allData.length;
            document.getElementById('uniqueMDPs').textContent = new Set(allData.map(r => r.mdpName)).size;
            document.getElementById('uniqueManagers').textContent = new Set(allData.map(r => r.managerName)).size;
            
            const avgScore = allData.length > 0 ? 
                allData.reduce((sum, r) => sum + r.compositeScore, 0) / allData.length : 0;
            document.getElementById('averageScore').textContent = avgScore.toFixed(1);
        }

        // Load recent activity
        function loadRecentActivity() {
            const activityContainer = document.getElementById('recentActivity');
            
            if (allData.length === 0) {
                activityContainer.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-info">
                            <h5>No recent activity</h5>
                            <p>No evaluations have been submitted yet</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Sort by timestamp and take last 10
            const recent = [...allData]
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 10);

            activityContainer.innerHTML = recent.map(item => `
                <div class="activity-item">
                    <div class="activity-info">
                        <h5>${item.mdpName} - ${item.function}</h5>
                        <p>Evaluated by ${item.managerName} | Score: ${item.compositeScore}</p>
                    </div>
                    <div class="activity-time">
                        ${formatTime(item.timestamp)}
                        <button class="delete-btn" onclick="deleteEvaluation('${item.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Format timestamp
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleDateString();
        }

        // Export functions
        function exportAllData() {
            if (allData.length === 0) {
                alert('No data to export');
                return;
            }
            exportDataAsCSV(allData, 'mdp-all-evaluations');
        }

        function exportFilteredData() {
            // This would integrate with dashboard filters if implemented
            exportAllData();
        }

        function exportDataAsCSV(data, filename) {
            const headers = [
                'ID', 'MDP Name', 'Function', 'Manager', 'Rotation', 'Composite Score',
                'Job Knowledge', 'Quality of Work', 'Communication', 'Initiative',
                'Function Specific 1', 'Function Specific 2', 'Timestamp'
            ];

            const csvContent = [
                headers.join(','),
                ...data.map(row => [
                    `"${row.id}"`,
                    `"${row.mdpName}"`,
                    `"${row.function}"`,
                    `"${row.managerName}"`,
                    row.rotation,
                    row.compositeScore,
                    row.jobKnowledge,
                    row.qualityOfWork,
                    row.communication,
                    row.initiative,
                    row.functionSpecific1 || '',
                    row.functionSpecific2 || '',
                    `"${row.timestamp}"`
                ].join(','))
            ].join('\n');

            downloadCSV(csvContent, `${filename}-${new Date().toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Admin actions
        function refreshStats() {
            loadAdminData();
            alert('Statistics refreshed successfully!');
        }

        function downloadBackup() {
            const backup = {
                timestamp: new Date().toISOString(),
                version: '1.0',
                data: allData
            };
            
            const content = JSON.stringify(backup, null, 2);
            const blob = new Blob([content], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mdp-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function viewSystemHealth() {
            fetch('/health')
                .then(response => response.json())
                .then(health => {
                    alert(`System Status: ${health.status}\nUptime: ${Math.floor(health.uptime / 60)} minutes\nPort: ${health.port}`);
                })
                .catch(error => {
                    alert('Failed to fetch system health');
                });
        }

        function clearCache() {
            localStorage.clear();
            sessionStorage.clear();
            alert('Application cache cleared successfully!');
        }

        function generateReport() {
            // This would generate a comprehensive performance report
            alert('Performance report generation coming soon!');
        }

        function viewLogs() {
            alert('System logs viewer coming soon!');
        }

        function findDuplicates() {
            const duplicates = [];
            const seen = new Set();
            
            allData.forEach(item => {
                const key = `${item.mdpName}-${item.managerName}-${item.rotation}`;
                if (seen.has(key)) {
                    duplicates.push(item);
                }
                seen.add(key);
            });

            if (duplicates.length > 0) {
                alert(`Found ${duplicates.length} potential duplicate(s):\n${duplicates.map(d => d.mdpName).join(', ')}`);
            } else {
                alert('No duplicates found!');
            }
        }

        function validateData() {
            const issues = [];
            
            allData.forEach(item => {
                if (!item.mdpName || !item.function || !item.managerName) {
                    issues.push(`Missing required fields: ${item.id}`);
                }
                if (item.compositeScore < 1 || item.compositeScore > 5) {
                    issues.push(`Invalid composite score: ${item.id}`);
                }
            });

            if (issues.length > 0) {
                alert(`Data validation issues:\n${issues.slice(0, 5).join('\n')}${issues.length > 5 ? '\n...' : ''}`);
            } else {
                alert('All data validated successfully!');
            }
        }

        // Analytics functions
        function viewTrends() {
            alert('Performance trends analysis coming soon!');
        }

        function managerAnalytics() {
            alert('Manager analytics dashboard coming soon!');
        }

        function functionAnalysis() {
            alert('Function analysis report coming soon!');
        }

        function rotationProgress() {
            alert('Rotation progress tracking coming soon!');
        }

        // Dangerous operations with confirmation
        function confirmBulkDelete() {
            showConfirmation('Delete all evaluations older than 6 months?', 'bulkDelete');
        }

        function confirmResetSystem() {
            showConfirmation('WARNING: This will delete ALL evaluation data. This action cannot be undone!', 'resetSystem');
        }

        // Delete specific evaluation
        async function deleteEvaluation(id) {
            if (!confirm('Are you sure you want to delete this evaluation?')) return;

            try {
                const response = await fetch(`/api/survey-responses/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Evaluation deleted successfully!');
                    loadAdminData();
                    loadRecentActivity();
                } else {
                    alert('Failed to delete evaluation');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error deleting evaluation');
            }
        }

        // Modal functions
        function showConfirmation(message, action) {
            document.getElementById('modalMessage').textContent = message;
            currentAction = action;
            document.getElementById('confirmModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            currentAction = null;
        }

        function executeAction() {
            if (currentAction === 'bulkDelete') {
                // Implement bulk delete logic
                alert('Bulk delete functionality coming soon!');
            } else if (currentAction === 'resetSystem') {
                // Implement system reset logic
                alert('System reset functionality coming soon!');
            }
            closeModal();
        }

        console.log('Admin panel initialized');
    </script>
</body>
</html>